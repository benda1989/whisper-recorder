<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Audio Player</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; color: #333; }
        .device-selector { margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .date-selector { margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 5px; }
        .playlist { margin-top: 20px; }
        .audio-item { 
            margin: 10px 0; 
            padding: 15px; 
            background: #fff; 
            border: 1px solid #e0e0e0; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
            transition: all 0.2s ease;
        }
        .audio-item:hover { 
            background: #fafafa; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateY(-1px);
        }
        .audio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .audio-title {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }
        .audio-info { 
            font-size: 11px; 
            color: #888; 
            text-align: right;
            line-height: 1.4;
        }
        .audio-controls { margin: 10px 0; }
        .current-playing { 
            background: #f0f8f0 !important; 
            border-color: #66bb6a; 
            box-shadow: 0 4px 16px rgba(102, 187, 106, 0.15);
        }
        
        /* Custom audio player styles */
        .custom-audio-player { 
            background: #f8f9fa; 
            border-radius: 8px; 
            padding: 12px; 
            margin: 8px 0; 
        }
        
        .player-controls { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-bottom: 8px;
        }
        
        .play-btn {
            background: linear-gradient(135deg, #6C7B7F, #5A6B6F);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 12px rgba(108, 123, 127, 0.3);
            transition: all 0.2s ease;
            position: relative;
        }
        
        .play-btn:hover { 
            background: linear-gradient(135deg, #7D8E93, #6A7B7F);
            transform: translateY(-1px);
            box-shadow: 0 5px 16px rgba(108, 123, 127, 0.4);
        }
        .play-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(108, 123, 127, 0.3);
        }
        .play-btn:disabled { 
            background: #ccc; 
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .play-btn.playing {
            background: linear-gradient(135deg, #42A5F5, #2196F3);
            animation: playing-pulse 2s infinite;
        }
        
        @keyframes playing-pulse {
            0%, 100% { box-shadow: 0 3px 12px rgba(66, 165, 245, 0.3); }
            50% { box-shadow: 0 3px 12px rgba(66, 165, 245, 0.6); }
        }
        
        .progress-container {
            flex: 1;
            background: linear-gradient(to right, #e8e8e8, #f0f0f0);
            border-radius: 12px;
            height: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            margin: 0 12px;
            border: 1px solid #e0e0e0;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #42A5F5, #2196F3);
            height: 100%;
            border-radius: 12px;
            width: 0%;
            transition: width 0.1s ease;
            box-shadow: 0 1px 3px rgba(33, 150, 243, 0.3);
        }
        
        .progress-handle {
            position: absolute;
            top: -5px;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #ffffff, #f5f5f5);
            border: 2px solid #2196F3;
            border-radius: 50%;
            cursor: grab;
            transform: translateX(-8px);
            opacity: 0;
            transition: all 0.2s ease;
            box-shadow: 0 3px 8px rgba(33, 150, 243, 0.4);
        }
        
        .progress-handle:hover {
            transform: translateX(-8px) scale(1.2);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.5);
            border-color: #1976D2;
        }
        
        .progress-handle:active {
            cursor: grabbing;
            transform: translateX(-8px) scale(1.3);
            background: linear-gradient(135deg, #f0f0f0, #e8e8e8);
        }
        
        .progress-container:hover .progress-handle { opacity: 1; }
        
        .time-display {
            font-size: 11px;
            color: #777;
            min-width: 85px;
            text-align: center;
            font-family: 'Courier New', monospace;
            background: rgba(0,0,0,0.05);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .loading { text-align: center; color: #666; padding: 20px; }
        .error { color: #d32f2f; text-align: center; padding: 20px; }
        select, button { 
            padding: 10px 16px; 
            margin: 5px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 14px;
            transition: all 0.2s ease;
        }
        button { 
            background: linear-gradient(135deg, #42A5F5, #2196F3); 
            color: white; 
            cursor: pointer; 
            border: none;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }
        button:hover { 
            background: linear-gradient(135deg, #1E88E5, #1976D2);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);
        }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        select {
            background: white;
            color: #333;
        }
        select:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }
        .stats { background: #fff3e0; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        .transcript-content {
            background: #f8f9fa;
            padding: 15px;
        }
        
        /* DateTime input box style optimization */
        input[type="datetime-local"]:focus,
        input[type="number"]:focus {
            outline: none !important;
            border-color: #4299e1 !important;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1) !important;
            transform: translateY(-1px);
        }
        
        input[type="datetime-local"]:hover,
        input[type="number"]:hover {
            border-color: #a0aec0;
            transform: translateY(-1px);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72,187,120,0.4) !important;
        }
        
        .transcript-content {
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
        }
        
        /* Recording schedule styles */
        .schedule-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }
        
        /* Overall background colors for different states */
        .schedule-item.status-pending {
            background: linear-gradient(135deg, #fef5e7, #fed7aa);
            border-color: #f59e0b;
        }
        .schedule-item.status-active {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border-color: #10b981;
        }
        .schedule-item.status-completed {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            border-color: #64748b;
        }
        
        .schedule-info {
            flex: 1;
        }
        .schedule-time {
            font-weight: 600;
            color: #2d3748;
        }
        .schedule-duration {
            color: #4a5568;
            font-size: 14px;
        }
        
        /* Color legend styles */
        .schedule-legend {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #666;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .legend-color.pending {
            background: linear-gradient(135deg, #fef5e7, #fed7aa);
        }
        .legend-color.active {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
        }
        .legend-color.completed {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Audio Player</h1>
        </div>

        <div class="device-selector">
            <label for="deviceSelect">Select Device:</label>
            <select id="deviceSelect" onchange="loadDeviceRecordings()">
                <option value="">-- Select Device --</option>
            </select>
            <button onclick="loadDevices()">Refresh Devices</button>
            <button id="scheduleBtn" onclick="showScheduleModal()" style="display: none; background: #4caf50;">ğŸ“… Schedule</button>
            <button id="liveMonitorBtn" onclick="toggleLiveMonitor()" style="display: none;">ğŸ§ Live Monitoring</button>
        </div>

        <div class="date-selector" id="dateSelector" style="display: none;">
            <label for="dateSelect">Select Date:</label>
            <select id="dateSelect" onchange="loadPlaylist()">
                <option value="">-- Select Date --</option>
            </select>
            <button id="transcriptBtn" onclick="showDailyTranscript()" style="margin-left: 15px; background: #4caf50; display: none;">ğŸ“„ View Daily Transcript</button>
            <label style="margin-left: 20px; display: inline-flex; align-items: center; gap: 6px; font-size: 14px; cursor: pointer;">
                <input type="checkbox" id="continuousPlayCheck" style="transform: scale(1.1);">
                <span>Continuous Play</span>
            </label>
        </div>

        <div class="stats" id="playlistStats" style="display: none;">
            <span id="statsText"></span>
        </div>

        <div class="playlist" id="playlist"></div>
    </div>

    <!-- Transcript text modal -->
    <div id="transcriptModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTranscriptModal()">&times;</span>
            <h2 id="transcriptTitle">Daily Transcript Text</h2>
            <div id="transcriptInfo" style="margin: 10px 0; font-size: 14px; color: #666;"></div>
            <div id="transcriptContent" class="transcript-content"></div>
        </div>
    </div>

    <!-- Recording schedule modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeScheduleModal()">&times;</span>
            <h2 id="scheduleTitle">Recording Schedule Configuration</h2>
            <div id="scheduleMessage"></div>
            
            <!-- Add schedule form -->
            <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #e2e8f0;">
                <div style="display: flex; gap: 20px; align-items: end; flex-wrap: wrap;">
                    <div style="display: flex; flex-direction: column; flex: 1; min-width: 200px;">
                        <label style="font-weight: 600; margin-bottom: 8px; color: #2d3748; font-size: 16px;">ğŸ“… Start Time</label>
                        <div style="position: relative;">
                            <input type="datetime-local" id="scheduleStartDateTime" 
                                   style="padding: 14px 18px; border: 2px solid #cbd5e0; border-radius: 10px; font-size: 16px; width: 90%; 
                                          background: #fff; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;" 
                                   required>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; min-width: 150px;">
                        <label style="font-weight: 600; margin-bottom: 8px; color: #2d3748; font-size: 16px;">â±ï¸ Duration (minutes)</label>
                        <input type="number" id="scheduleDuration" min="1" max="480" value="60" 
                               style="padding: 14px 18px; border: 2px solid #cbd5e0; border-radius: 10px; font-size: 16px; 
                                      background: #fff; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;" required>
                    </div>
                    <button onclick="addSchedule()" 
                            style="background: linear-gradient(135deg, #48bb78, #38a169); color: white; 
                                   padding: 16px 28px; border: none; border-radius: 10px; cursor: pointer; 
                                   font-size: 16px; font-weight: 600; min-height: 56px;
                                   box-shadow: 0 4px 12px rgba(72,187,120,0.3);
                                   transition: all 0.2s ease; white-space: nowrap;">
                        âœ¨ Add Schedule
                    </button>
                </div>
            </div>
            
            <!-- Schedule list -->
            <div>
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                    <h3>Current Recording Schedules</h3>
                    <div class="schedule-legend">
                        <div class="legend-item">
                            <div class="legend-color pending"></div>
                            <span>Pending</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color active"></div>
                            <span>Recording</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color completed"></div>
                            <span>Completed</span>
                        </div>
                    </div>
                </div>
                <div id="schedulesContainer">
                    <div style="text-align: center; color: #a0aec0; padding: 20px; font-style: italic;">Loading schedules...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentAudio = null;
        let currentPlayingIndex = -1;
        let playlist = [];
        let isLiveMonitoring = false;
        let currentDeviceInfo = null;
        let autoPlayNext = false;
        
        // Custom audio player status
        let customAudioPlayers = {};  // Store each audio's player status
        let progressUpdateIntervals = {};  // Progress update timers

        // Web Audio API variables
        let audioContext = null;
        let audioQueue = [];
        let isPlaying = false;
        let nextStartTime = 0;
        let audioBufferQueue = [];
        
        // WebSocket audio stream variables
        let audioWebSocket = null;
        let isWebSocketConnected = false;

        // Load device list
        async function loadDevices() {
            try {
                const response = await fetch('/devices');
                const data = await response.json();
                const deviceSelect = document.getElementById('deviceSelect');
                deviceSelect.innerHTML = '<option value="">-- Select Device --</option>';
                
                data.devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.device_id;
                    // ä¼˜å…ˆæ˜¾ç¤ºè®¾å¤‡åç§°ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºè®¾å¤‡ID
                    let displayName = device.device_name || device.device_id;
                    if (device.is_online) {
                        displayName += ' ğŸ§Live';
                    } else {
                        displayName += ' ğŸ“History';
                    }  
                    option.textContent = displayName;
                    deviceSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load device list:', error);
                showError('Failed to load device list');
            }
        }

        // åŠ è½½è®¾å¤‡å½•éŸ³åˆ—è¡¨
        async function loadDeviceRecordings() {
            const deviceId = document.getElementById('deviceSelect').value;
            if (!deviceId) {
                document.getElementById('dateSelector').style.display = 'none';
                document.getElementById('playlist').innerHTML = '';
                document.getElementById('playlistStats').style.display = 'none';
                document.getElementById('liveMonitorBtn').style.display = 'none';
                document.getElementById('scheduleBtn').style.display = 'none';
                stopLiveMonitor();
                return;
            }
            
            // æ¸…ç©ºç»Ÿè®¡ä¿¡æ¯
            document.getElementById('playlistStats').style.display = 'none';

            try {
                // æ£€æŸ¥è®¾å¤‡å®æ—¶çŠ¶æ€
                await checkLiveStatus(deviceId);
                
                const response = await fetch(`/devices/${deviceId}/recordings`);
                const data = await response.json();
                const dateSelect = document.getElementById('dateSelect');
                dateSelect.innerHTML = '<option value="">-- Select Date --</option>';

                // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                const sortedDates = Object.keys(data.recordings_by_date).sort().reverse();
                
                sortedDates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    const fileCount = data.recordings_by_date[date].length;
                    option.textContent = `${date} (${fileCount} files)`;
                    dateSelect.appendChild(option);
                });

                document.getElementById('dateSelector').style.display = 'block';
                document.getElementById('playlist').innerHTML = '';
            } catch (error) {
                console.error('Failed to load recording list:', error);
                showError('Failed to load recording list');
            }
        }

        // æ£€æŸ¥è®¾å¤‡å®æ—¶çŠ¶æ€
        async function checkLiveStatus(deviceId) {
            try {
                const response = await fetch(`/devices/${deviceId}/live_status`);
                currentDeviceInfo = await response.json();
                
                const liveBtn = document.getElementById('liveMonitorBtn');
                const scheduleBtn = document.getElementById('scheduleBtn');
                if (currentDeviceInfo.is_online) {
                    liveBtn.style.display = 'inline-block';
                } else {
                    liveBtn.style.display = 'none';
                    stopLiveMonitor();
                }
                // å½•éŸ³è®¡åˆ’æŒ‰é’®å§‹ç»ˆæ˜¾ç¤ºï¼ˆåœ¨çº¿å’Œç¦»çº¿è®¾å¤‡éƒ½å¯ä»¥é…ç½®è®¡åˆ’ï¼‰
                scheduleBtn.style.display = 'inline-block';
            } catch (error) {
                console.error('Failed to check device status:', error);
                document.getElementById('liveMonitorBtn').style.display = 'none';
            }
        }

        // Toggle live monitoring
        async function toggleLiveMonitor() {
            const deviceId = document.getElementById('deviceSelect').value;
            if (!deviceId) return;

            if (isLiveMonitoring) {
                stopLiveMonitor();
            } else {
                startLiveMonitor(deviceId);
            }
        }

        // Initialize Web Audio API
        async function initWebAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                return true;
            } catch (error) {
                console.error('Web Audio API initialization failed:', error);
                return false;
            }
        }

        // Decode audio data
        async function decodeAudioData(arrayBuffer) {
            try {
                return await audioContext.decodeAudioData(arrayBuffer);
            } catch (error) {
                console.error('Audio decoding failed:', error);
                return null;
            }
        }

        // Play audio buffer
        function playAudioBuffer(audioBuffer, startTime = null) {
            if (!audioContext || !audioBuffer) return null;
            
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            
            const actualStartTime = startTime || audioContext.currentTime;
            source.start(actualStartTime);
            
            return { source, duration: audioBuffer.duration, startTime: actualStartTime };
        }

        // Start live monitoring
        async function startLiveMonitor(deviceId) {
            if (isLiveMonitoring) return;
            
            // Initialize Web Audio API
            const webAudioReady = await initWebAudio();
            
            isLiveMonitoring = true;
            document.getElementById('liveMonitorBtn').textContent = 'â¹ï¸ Stop Monitoring';
            
            // åˆ›å»ºå®æ—¶éŸ³é¢‘æ’­æ”¾å™¨
            const liveAudioDiv = document.createElement('div');
            liveAudioDiv.id = 'liveAudioPlayer';
            liveAudioDiv.innerHTML = `
                <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin: 10px 0; border: 2px solid #4caf50;">
                    <div id="liveStatus" style="margin: 10px 0; font-size: 14px; color: #333;">Connecting to WebSocket audio stream...</div>
                    <div id="bufferStatus" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
                </div>
            `;
            
            document.getElementById('playlist').insertBefore(liveAudioDiv, document.getElementById('playlist').firstChild);
            
            // é‡ç½®æ’­æ”¾çŠ¶æ€
            audioQueue = [];
            audioBufferQueue = [];
            isPlaying = false;
            nextStartTime = 0;
            autoPlayNext = true;
            audioChunkCounter = 0;
            
            // Connect WebSocket audio stream
            connectAudioWebSocket(deviceId);
        }

        // Connect WebSocket audio stream
        function connectAudioWebSocket(deviceId) {
            // æ„å»ºWebSocket URL
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/live_audio/${deviceId}`;
            
            console.log('ğŸ”Œ è¿æ¥éŸ³é¢‘WebSocket:', wsUrl);
            
            try {
                audioWebSocket = new WebSocket(wsUrl);
                
                audioWebSocket.onopen = function(event) {
                    console.log('âœ… WebSocket audio stream connected successfully');
                    isWebSocketConnected = true;
                    updateLiveStatus('Connection successful, waiting for audio data...');
                    
                    // Send heartbeat
                    const heartbeat = setInterval(() => {
                        if (audioWebSocket && audioWebSocket.readyState === WebSocket.OPEN) {
                            audioWebSocket.send(JSON.stringify({ type: 'ping' }));
                        } else {
                            clearInterval(heartbeat);
                        }
                    }, 30000);
                };
                
                audioWebSocket.onmessage = function(event) {
                    // Handle binary audio data directly, ignore JSON messages
                    if (event.data instanceof ArrayBuffer) {
                        handleAudioBinary(event.data);
                    } else if (event.data instanceof Blob) {
                        event.data.arrayBuffer().then(arrayBuffer => {
                            handleAudioBinary(arrayBuffer);
                        });
                    } else if (typeof event.data === 'string') {
                        try {
                            const message = JSON.parse(event.data);
                            if (message.type === 'connected') {
                                updateLiveStatus(`WebSocket connected`);
                            }
                        } catch (e) {
                            // Ignore invalid JSON
                        }
                    }
                };
                
                audioWebSocket.onclose = function(event) {
                    console.log('âŒ WebSocket audio stream disconnected');
                    isWebSocketConnected = false;
                    updateLiveStatus('WebSocket disconnected');
                };
                
                audioWebSocket.onerror = function(error) {
                    console.error('âŒ WebSocket audio stream error:', error);
                    updateLiveStatus('WebSocket connection error');
                };
                
            } catch (error) {
                console.error('âŒ Failed to create WebSocket connection:', error);
                updateLiveStatus('WebSocket connection failed');
            }
        }

        // Audio chunk counter
        let audioChunkCounter = 0;
        
        // Handle binary audio data (simplified version)
        async function handleAudioBinary(audioData) {
            if (!audioData || audioData.byteLength === 0) {
                return;
            }
            
            audioChunkCounter++;
            
            try {                
                // Decode audio data
                const audioBuffer = await decodeAudioData(audioData);
                if (audioBuffer) {
                    audioBufferQueue.push(audioBuffer);
                    
                    // Calculate total samples and duration in current buffer (16kHz sample rate)
                    const totalSamples = audioBufferQueue.reduce((total, buffer) => total + buffer.length, 0);
                    const totalBufferedTime = totalSamples / 16000.0;
                    
                    // Limit buffer duration to no more than 8 seconds (avoid excessive delay)
                    while (totalBufferedTime > 8.0 && audioBufferQueue.length > 1) {
                        audioBufferQueue.shift();
                    }
                    
                    updateBufferStatus();
                    
                    // å¦‚æœæ’­æ”¾ä¸­ä¸”ç¼“å†²åŒºæœ‰æ•°æ®ï¼Œç»§ç»­æ’é˜Ÿæ’­æ”¾
                    if (isPlaying && audioBufferQueue.length > 0) {
                        scheduleNextBuffer();
                    }
                    
                    // å¦‚æœè¿˜æ²¡å¼€å§‹æ’­æ”¾ä¸”ç¼“å†²åŒºè¾¾åˆ°2ç§’ï¼Œè‡ªåŠ¨å¼€å§‹æ’­æ”¾
                    if (!isPlaying && totalBufferedTime >= 2.0) {
                        console.log(`ğŸ¬ è‡ªåŠ¨å¼€å§‹æ’­æ”¾ï¼Œç¼“å†²åŒº: ${totalSamples}æ ·æœ¬ = ${totalBufferedTime.toFixed(1)}ç§’`);
                        await startLivePlayback();
                    }
                } else {
                    console.error('âŒ éŸ³é¢‘è§£ç å¤±è´¥');
                }
                
            } catch (error) {
                console.error('å¤„ç†éŸ³é¢‘æ•°æ®å¤±è´¥:', error);
            }
        }


        // å®‰æ’ä¸‹ä¸€ä¸ªéŸ³é¢‘ç¼“å†²åŒºæ’­æ”¾
        function scheduleNextBuffer() {
            if (audioBufferQueue.length === 0 || !isPlaying) return;
            
            const audioBuffer = audioBufferQueue.shift();
            const currentTime = audioContext.currentTime;
            
            // æ›´ç²¾ç¡®çš„æ—¶é—´åŒæ­¥ - ç¡®ä¿è¿ç»­æ’­æ”¾
            if (nextStartTime <= currentTime + 0.01) {
                nextStartTime = currentTime + 0.02; // ç•¥å¾®æå‰ç¡®ä¿æ— é—´éš™
            }
            
            // æ’­æ”¾éŸ³é¢‘
            const playInfo = playAudioBuffer(audioBuffer, nextStartTime);
            if (playInfo) {
                audioQueue.push(playInfo);
                // ç²¾ç¡®è®¡ç®—ä¸‹ä¸€ä¸ªç‰‡æ®µå¼€å§‹æ—¶é—´ï¼Œç¡®ä¿æ— ç¼è¿æ¥
                nextStartTime = playInfo.startTime + playInfo.duration;                
                // æ¸…ç†å·²æ’­æ”¾å®Œçš„éŸ³é¢‘æº
                setTimeout(() => {
                    audioQueue.shift();
                }, (playInfo.startTime + playInfo.duration - currentTime + 0.1) * 1000);
            }
            
            updateBufferStatus();
        }

        // å¼€å§‹å®æ—¶æ’­æ”¾
        async function startLivePlayback() {
            if (!audioContext) {
                alert('Web Audio API æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
            
            isPlaying = true;
            nextStartTime = audioContext.currentTime + 0.1; // ç¨å¾®å»¶è¿Ÿå¯åŠ¨            
            // ä¸€æ¬¡æ€§è°ƒåº¦å‰å‡ ä¸ªéŸ³é¢‘ç‰‡æ®µï¼Œç¡®ä¿è¿ç»­æ€§
            let scheduledCount = 0;
            const maxSchedule = Math.min(4, audioBufferQueue.length);
            
            while (scheduledCount < maxSchedule && audioBufferQueue.length > 0) {
                scheduleNextBuffer();
                scheduledCount++;
            }
            
            updateBufferStatus();
            
            // æ›´é¢‘ç¹åœ°æ£€æŸ¥å’Œè¡¥å……æ’­æ”¾é˜Ÿåˆ—
            const playbackChecker = setInterval(() => {
                if (!isPlaying) {
                    clearInterval(playbackChecker);
                    return;
                }
                
                // ä¿æŒæ’­æ”¾é˜Ÿåˆ—æœ‰2-3ä¸ªéŸ³é¢‘ç‰‡æ®µ
                while (audioQueue.length < 3 && audioBufferQueue.length > 0) {
                    scheduleNextBuffer();
                }
                
                // å¦‚æœç¼“å†²åŒºè¿‡å°‘ï¼Œè­¦å‘Š
                if (audioBufferQueue.length <= 1 && audioQueue.length <= 1) {
                    console.warn('âš ï¸ ç¼“å†²åŒºä¸¥é‡ä¸è¶³');
                }
            }, 100); // æ›´é¢‘ç¹çš„æ£€æŸ¥ - 100ms
        }

        // åœæ­¢å®æ—¶æ’­æ”¾
        function stopLivePlayback() {
            isPlaying = false;
            
            // åœæ­¢æ‰€æœ‰æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘æº
            audioQueue.forEach(item => {
                if (item.source) {
                    try {
                        item.source.stop();
                    } catch (e) {
                        // å¿½ç•¥å·²åœæ­¢çš„æº
                    }
                }
            });
            
            audioQueue = [];
            nextStartTime = 0;
            updateBufferStatus();
        }

        // æ›´æ–°ç¼“å†²åŒºçŠ¶æ€æ˜¾ç¤º
        function updateBufferStatus() {
            const bufferStatus = document.getElementById('bufferStatus');
            if (bufferStatus) {
                const playingCount = audioQueue.length;
                const bufferCount = audioBufferQueue.length;
                // åŸºäºæ ·æœ¬æ•°è®¡ç®—ç¼“å†²æ—¶é•¿ï¼ˆ16kHzï¼‰
                const totalSamples = audioBufferQueue.reduce((total, buffer) => total + buffer.length, 0);
                const bufferedTime = totalSamples / 16000.0;
                const wsStatus = isWebSocketConnected ? 'ğŸ”— connected' : 'ğŸ”Œ Unconnected';
                bufferStatus.textContent = `${wsStatus} | Playing: ${playingCount} | Buffered: ${bufferedTime.toFixed(1)}s | Processed: ${audioChunkCounter}`;
            }
        }
        
        // æ›´æ–°å®æ—¶çŠ¶æ€æ˜¾ç¤º (é‡è½½å‡½æ•°)
        function updateLiveStatus(statusText) {
            const liveStatus = document.getElementById('liveStatus');
            if (liveStatus && statusText) {
                liveStatus.textContent = statusText;
            }
        }

        // åœæ­¢å®æ—¶ç›‘å¬
        function stopLiveMonitor() {
            if (!isLiveMonitoring) return;
            
            isLiveMonitoring = false;
            document.getElementById('liveMonitorBtn').textContent = 'ğŸ§ Start Live Monitoring';
            
            // åœæ­¢éŸ³é¢‘æ’­æ”¾
            stopLivePlayback();
            
            // å…³é—­WebSocketè¿æ¥
            if (audioWebSocket) {
                audioWebSocket.close();
                audioWebSocket = null;
                isWebSocketConnected = false;
            }
            
            
            const liveAudioPlayer = document.getElementById('liveAudioPlayer');
            if (liveAudioPlayer) {
                liveAudioPlayer.remove();
            }
            
            // æ¸…ç†éŸ³é¢‘ç¼“å†²åŒº
            audioBufferQueue = [];
            audioQueue = [];
            audioChunkCounter = 0;
        }



        // åŠ è½½æ’­æ”¾åˆ—è¡¨
        async function loadPlaylist() {
            const deviceId = document.getElementById('deviceSelect').value;
            const date = document.getElementById('dateSelect').value;
            
            if (!deviceId || !date) {
                document.getElementById('playlist').innerHTML = '';
                document.getElementById('transcriptBtn').style.display = 'none';
                return;
            }
            
            // æ˜¾ç¤ºè½¬å½•æŒ‰é’®
            document.getElementById('transcriptBtn').style.display = 'inline-block';

            document.getElementById('playlist').innerHTML = '<div class="loading">Loading playlist...</div>';

            try {
                const response = await fetch(`/devices/${deviceId}/playlist/${date}`);
                const data = await response.json();
                playlist = data.playlist;

                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                document.getElementById('statsText').textContent = 
                    `Total: ${data.total_files} files, Duration: ${formatDuration(data.total_duration)}`;
                document.getElementById('playlistStats').style.display = 'block';

                // æ¸²æŸ“æ’­æ”¾åˆ—è¡¨
                const playlistDiv = document.getElementById('playlist');
                playlistDiv.innerHTML = '';

                playlist.forEach((audio, index) => {
                    const audioItem = document.createElement('div');
                    audioItem.className = 'audio-item';
                    audioItem.id = `audio-${index}`;
                    
                    audioItem.innerHTML = `
                        <div class="audio-header">
                            <div class="audio-title">${audio.filename}</div>
                            <div class="audio-info">
                                ${formatDuration(audio.duration)} â€¢ ${formatBytes(audio.size)}<br>
                                <span style="color: #aaa; font-size: 10px;">${new Date(audio.created_time * 1000).toLocaleString('zh-CN', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'})}</span>
                            </div>
                        </div>
                        <div class="custom-audio-player">
                            <div class="player-controls">
                                <button class="play-btn" id="playBtn-${index}" onclick="togglePlay(${index})">
                                    â–¶ï¸
                                </button>
                                <div class="progress-container" onclick="seekAudio(event, ${index})">
                                    <div class="progress-bar" id="progressBar-${index}"></div>
                                    <div class="progress-handle" id="progressHandle-${index}" 
                                         onmousedown="startDrag(event, ${index})"></div>
                                </div>
                                <div class="time-display" id="timeDisplay-${index}">
                                    0:00 / ${formatDuration(audio.duration)}
                                </div>
                            </div>
                            <audio id="audioElement-${index}" preload="none" onended="onAudioEnded(${index})">
                                <source src="${audio.url}" type="audio/wav">
                                Your browser does not support audio playback
                            </audio>
                        </div>
                    `;
                    
                    playlistDiv.appendChild(audioItem);
                    
                    // åˆå§‹åŒ–æ’­æ”¾å™¨çŠ¶æ€
                    customAudioPlayers[index] = {
                        isPlaying: false,
                        duration: audio.duration,
                        currentTime: 0
                    };
                });


            } catch (error) {
                console.error('Failed to load playlist:', error);
                showError('Failed to load playlist');
            }
        }

        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // è‡ªå®šä¹‰æ’­æ”¾å™¨æ§åˆ¶å‡½æ•°
        function togglePlay(index) {
            const audioElement = document.getElementById(`audioElement-${index}`);
            const playBtn = document.getElementById(`playBtn-${index}`);
            const playerState = customAudioPlayers[index];
            
            if (!audioElement) return;
            
            if (playerState.isPlaying) {
                // æš‚åœæ’­æ”¾
                audioElement.pause();
                playBtn.textContent = 'â–¶ï¸';
                playBtn.classList.remove('playing');
                playerState.isPlaying = false;
                clearInterval(progressUpdateIntervals[index]);
                
                // ç§»é™¤å½“å‰æ’­æ”¾æ ‡è®°
                document.getElementById(`audio-${index}`).classList.remove('current-playing');
                if (currentPlayingIndex === index) {
                    currentPlayingIndex = -1;
                    currentAudio = null;
                }
            } else {
                // åœæ­¢å…¶ä»–æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘
                stopAll();
                
                // å¼€å§‹æ’­æ”¾
                audioElement.play();
                playBtn.textContent = 'â¸ï¸';
                playBtn.classList.add('playing');
                playerState.isPlaying = true;
                currentPlayingIndex = index;
                currentAudio = audioElement;
                
                // æ·»åŠ å½“å‰æ’­æ”¾æ ‡è®°
                document.getElementById(`audio-${index}`).classList.add('current-playing');
                
                // å¯åŠ¨è¿›åº¦æ›´æ–°
                startProgressUpdate(index);
            }
            
            // æ‚¬æµ®æŒ‰é’®ä¼šè‡ªåŠ¨è·Ÿéšæ’­æ”¾çŠ¶æ€
        }
        
        // å¼€å§‹è¿›åº¦æ›´æ–°
        function startProgressUpdate(index) {
            const audioElement = document.getElementById(`audioElement-${index}`);
            const playerState = customAudioPlayers[index];
            
            progressUpdateIntervals[index] = setInterval(() => {
                if (audioElement && !audioElement.paused && !isDragging) {
                    const currentTime = audioElement.currentTime;
                    const duration = audioElement.duration || playerState.duration;
                    const progress = currentTime / duration;
                    
                    // æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤º
                    updateProgressDisplay(index, progress, currentTime, duration);
                    
                    // æ›´æ–°çŠ¶æ€
                    playerState.currentTime = currentTime;
                } else if (audioElement && audioElement.paused) {
                    clearInterval(progressUpdateIntervals[index]);
                }
            }, 100);
        }
        
        // æ‹–æ‹½çŠ¶æ€ç®¡ç†
        let isDragging = false;
        let dragIndex = -1;
        
        // éŸ³é¢‘è·³è½¬
        function seekAudio(event, index) {
            if (isDragging) return; // æ‹–æ‹½æ—¶ä¸å“åº”ç‚¹å‡»
            
            const progressContainer = event.currentTarget;
            const audioElement = document.getElementById(`audioElement-${index}`);
            const playerState = customAudioPlayers[index];
            
            if (!audioElement) return;
            
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const progress = Math.max(0, Math.min(1, clickX / rect.width));
            const duration = audioElement.duration || playerState.duration;
            const newTime = progress * duration;
            
            // è®¾ç½®æ–°çš„æ’­æ”¾ä½ç½®
            audioElement.currentTime = newTime;
            playerState.currentTime = newTime;
            
            // ç«‹å³æ›´æ–°è¿›åº¦æ¡
            updateProgressDisplay(index, progress, newTime, duration);
        }
        
        // æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤º
        function updateProgressDisplay(index, progress, currentTime, duration) {
            const progressPercent = progress * 100;
            document.getElementById(`progressBar-${index}`).style.width = progressPercent + '%';
            document.getElementById(`progressHandle-${index}`).style.left = progressPercent + '%';
            document.getElementById(`timeDisplay-${index}`).textContent = 
                `${formatDuration(currentTime)} / ${formatDuration(duration)}`;
        }
        
        // å¼€å§‹æ‹–æ‹½
        function startDrag(event, index) {
            event.preventDefault();
            event.stopPropagation();
            
            isDragging = true;
            dragIndex = index;
            
            // æ·»åŠ å…¨å±€äº‹ä»¶ç›‘å¬
            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', endDrag);
            
            // æ”¹å˜å…‰æ ‡æ ·å¼
            document.body.style.cursor = 'grabbing';
            document.body.style.userSelect = 'none';
        }
        
        // å¤„ç†æ‹–æ‹½
        function handleDrag(event) {
            if (!isDragging || dragIndex === -1) return;
            
            event.preventDefault();
            
            const progressContainer = document.querySelector(`#audio-${dragIndex} .progress-container`);
            const audioElement = document.getElementById(`audioElement-${dragIndex}`);
            const playerState = customAudioPlayers[dragIndex];
            
            if (!progressContainer || !audioElement) return;
            
            const rect = progressContainer.getBoundingClientRect();
            const mouseX = event.clientX - rect.left;
            const progress = Math.max(0, Math.min(1, mouseX / rect.width));
            const duration = audioElement.duration || playerState.duration;
            const newTime = progress * duration;
            
            // å®æ—¶æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤ºï¼ˆä¸æ”¹å˜éŸ³é¢‘ä½ç½®ï¼‰
            updateProgressDisplay(dragIndex, progress, newTime, duration);
        }
        
        // ç»“æŸæ‹–æ‹½
        function endDrag(event) {
            if (!isDragging || dragIndex === -1) return;
            
            event.preventDefault();
            
            const progressContainer = document.querySelector(`#audio-${dragIndex} .progress-container`);
            const audioElement = document.getElementById(`audioElement-${dragIndex}`);
            const playerState = customAudioPlayers[dragIndex];
            
            if (progressContainer && audioElement) {
                const rect = progressContainer.getBoundingClientRect();
                const mouseX = event.clientX - rect.left;
                const progress = Math.max(0, Math.min(1, mouseX / rect.width));
                const duration = audioElement.duration || playerState.duration;
                const newTime = progress * duration;
                
                // è®¾ç½®æœ€ç»ˆçš„æ’­æ”¾ä½ç½®
                audioElement.currentTime = newTime;
                playerState.currentTime = newTime;
            }
            
            // æ¸…ç†æ‹–æ‹½çŠ¶æ€
            isDragging = false;
            dragIndex = -1;
            
            // ç§»é™¤å…¨å±€äº‹ä»¶ç›‘å¬
            document.removeEventListener('mousemove', handleDrag);
            document.removeEventListener('mouseup', endDrag);
            
            // æ¢å¤å…‰æ ‡æ ·å¼
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        }
        
        // éŸ³é¢‘æ’­æ”¾ç»“æŸå›è°ƒ
        function onAudioEnded(index) {
            const playBtn = document.getElementById(`playBtn-${index}`);
            const playerState = customAudioPlayers[index];
            
            // é‡ç½®æ’­æ”¾çŠ¶æ€
            playBtn.textContent = 'â–¶ï¸';
            playBtn.classList.remove('playing');
            playerState.isPlaying = false;
            playerState.currentTime = 0;
            
            // é‡ç½®è¿›åº¦æ¡
            document.getElementById(`progressBar-${index}`).style.width = '0%';
            document.getElementById(`progressHandle-${index}`).style.left = '0%';
            document.getElementById(`timeDisplay-${index}`).textContent = 
                `0:00 / ${formatDuration(playerState.duration)}`;
            
            // æ¸…é™¤è¿›åº¦æ›´æ–°
            clearInterval(progressUpdateIntervals[index]);
            
            // ç§»é™¤å½“å‰æ’­æ”¾æ ‡è®°
            document.getElementById(`audio-${index}`).classList.remove('current-playing');
            
            // è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€ä¸ª
            if (currentPlayingIndex === index) {
                playNext();
            }
            
            // æ‚¬æµ®æŒ‰é’®ä¼šè‡ªåŠ¨è·Ÿéšæ’­æ”¾çŠ¶æ€
        }

        // æ’­æ”¾ä¸‹ä¸€ä¸ª
        function playNext() {
            // æ£€æŸ¥æ˜¯å¦å‹¾é€‰äº†è¿ç»­æ’­æ”¾
            const continuousCheck = document.getElementById('continuousPlayCheck');
            if (!continuousCheck || !continuousCheck.checked) {
                // æ²¡æœ‰å‹¾é€‰è¿ç»­æ’­æ”¾ï¼Œç›´æ¥åœæ­¢
                currentPlayingIndex = -1;
                currentAudio = null;
                return;
            }
            
            // å‹¾é€‰äº†è¿ç»­æ’­æ”¾ï¼Œæ’­æ”¾ä¸‹ä¸€é¦–
            if (currentPlayingIndex >= 0 && currentPlayingIndex < playlist.length - 1) {
                // æ’­æ”¾ä¸‹ä¸€é¦–
                const nextIndex = currentPlayingIndex + 1;
                currentPlayingIndex = -1;  // å…ˆé‡ç½®ï¼Œé¿å…togglePlayé‡Œçš„stopAllå½±å“
                currentAudio = null;
                togglePlay(nextIndex);
            } else {
                // å…¨éƒ¨æ’­æ”¾å®Œæˆ
                currentPlayingIndex = -1;
                currentAudio = null;
            }
        }

        // æ’­æ”¾æŒ‡å®šéŸ³é¢‘ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
        function playAudio(index) {
            stopAll();
            togglePlay(index);
        }

        // è¿ç»­æ’­æ”¾å…¨éƒ¨ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
        function playAll() {
            // è‡ªåŠ¨å‹¾é€‰è¿ç»­æ’­æ”¾å¹¶ä»ç¬¬ä¸€é¦–å¼€å§‹
            const continuousCheck = document.getElementById('continuousPlayCheck');
            if (continuousCheck) {
                continuousCheck.checked = true;
            }
            if (playlist.length > 0) {
                togglePlay(0);
            }
        }

        // åœæ­¢æ‰€æœ‰æ’­æ”¾
        function stopAll() {
            
            // åœæ­¢æ‰€æœ‰è‡ªå®šä¹‰æ’­æ”¾å™¨
            Object.keys(customAudioPlayers).forEach(index => {
                const audioElement = document.getElementById(`audioElement-${index}`);
                const playBtn = document.getElementById(`playBtn-${index}`);
                const playerState = customAudioPlayers[index];
                
                if (audioElement && playerState.isPlaying) {
                    audioElement.pause();
                    audioElement.currentTime = 0;
                    playBtn.textContent = 'â–¶ï¸';
                    playBtn.classList.remove('playing');
                    playerState.isPlaying = false;
                    playerState.currentTime = 0;
                    
                    // é‡ç½®è¿›åº¦æ¡
                    document.getElementById(`progressBar-${index}`).style.width = '0%';
                    document.getElementById(`progressHandle-${index}`).style.left = '0%';
                    document.getElementById(`timeDisplay-${index}`).textContent = 
                        `0:00 / ${formatDuration(playerState.duration)}`;
                    
                    // æ¸…é™¤è¿›åº¦æ›´æ–°
                    clearInterval(progressUpdateIntervals[index]);
                }
            });
            
            // æ¸…é™¤æ’­æ”¾æ ‡è®°
            document.querySelectorAll('.audio-item').forEach(item => {
                item.classList.remove('current-playing');
            });
            
            currentPlayingIndex = -1;
            currentAudio = null;
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            document.getElementById('playlist').innerHTML = `<div class="error">${message}</div>`;
        }

        // æ˜¾ç¤ºå½“æ—¥Transcript
        async function showDailyTranscript() {
            const deviceId = document.getElementById('deviceSelect').value;
            const date = document.getElementById('dateSelect').value;
            
            if (!deviceId || !date) {
                alert('Please select device and date first');
                return;
            }
            
            try {
                document.getElementById('transcriptContent').textContent = 'Loading transcript...';
                document.getElementById('transcriptModal').style.display = 'block';
                
                const response = await fetch(`/devices/${deviceId}/daily_transcript/${date}`);
                const data = await response.json();
                
                // è·å–è®¾å¤‡æ˜¾ç¤ºåç§°å¹¶æ›´æ–°å¼¹çª—æ ‡é¢˜
                const deviceSelect = document.getElementById('deviceSelect');
                const selectedOption = deviceSelect.options[deviceSelect.selectedIndex];
                const deviceDisplayName = selectedOption ? selectedOption.textContent.replace(' ğŸ§Live', '').replace(' ğŸ“History', '') : deviceId;
                
                document.getElementById('transcriptTitle').textContent = `${deviceDisplayName} - ${date} Transcript`;
                
                if (data.transcript) {
                    document.getElementById('transcriptInfo').textContent = 
                        `å…± ${data.files_count}  filesï¼Œ${data.total_lines}  lines of text`;
                    document.getElementById('transcriptContent').textContent = data.transcript;
                } else {
                    document.getElementById('transcriptInfo').textContent = 'No transcript for this date';
                    document.getElementById('transcriptContent').textContent = 'No transcript files found for current date';
                }
                
            } catch (error) {
                console.error('è·å–Transcriptå¤±è´¥:', error);
                document.getElementById('transcriptContent').textContent = 'è·å–Transcriptå¤±è´¥: ' + error.message;
            }
        }
        
        // å…³é—­Transcriptå¼¹çª—
        function closeTranscriptModal() {
            document.getElementById('transcriptModal').style.display = 'none';
        }

        // æ˜¾ç¤ºå½•éŸ³è®¡åˆ’å¼¹çª—
        async function showScheduleModal() {
            const deviceId = document.getElementById('deviceSelect').value;
            if (!deviceId) {
                alert('Please select device first');
                return;
            }
            
            // è·å–å½“å‰é€‰æ‹©çš„è®¾å¤‡åç§°
            const deviceSelect = document.getElementById('deviceSelect');
            const selectedOption = deviceSelect.options[deviceSelect.selectedIndex];
            const deviceDisplayName = selectedOption ? selectedOption.textContent.replace(' ğŸ§Live', '').replace(' ğŸ“History', '') : deviceId;
            
            document.getElementById('scheduleTitle').textContent = `${deviceDisplayName} -Schedule Configuration`;
            document.getElementById('scheduleModal').style.display = 'block';
            
            // è®¾ç½®é»˜è®¤çš„24å°æ—¶åˆ¶æ—¶é—´
            setDefaultDateTime();
            
            await loadSchedules();
        }

        // å…³é—­å½•éŸ³è®¡åˆ’å¼¹çª—
        function closeScheduleModal() {
            document.getElementById('scheduleModal').style.display = 'none';
        }

        // åŠ è½½å½•éŸ³è®¡åˆ’
        async function loadSchedules() {
            const deviceId = document.getElementById('deviceSelect').value;
            if (!deviceId) return;
            
            try {
                const response = await fetch(`/schedules/${deviceId}`);
                const data = await response.json();
                displaySchedules(data.schedules || []);
            } catch (error) {
                showScheduleMessage('åŠ è½½è®¡åˆ’å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºå½•éŸ³è®¡åˆ’åˆ—è¡¨
        function displaySchedules(schedules) {
            const container = document.getElementById('schedulesContainer');
            
            if (schedules.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #a0aec0; padding: 20px; font-style: italic;">No schedules</div>';
                return;
            }
            
            container.innerHTML = '';
            
            schedules.forEach(schedule => {
                const startTime = new Date(schedule.start_at * 1000);
                const endTime = new Date((schedule.start_at + schedule.duration) * 1000);
                const durationMinutes = Math.round(schedule.duration / 60);
                
                let status = 'pending';
                
                const now = Date.now() / 1000;
                if (schedule.is_active) {
                    status = 'active';
                } else if (now > schedule.start_at + schedule.duration) {
                    status = 'completed';
                }
                
                const item = document.createElement('div');
                item.className = `schedule-item status-${status}`;
                
                item.innerHTML = `
                    <div class="schedule-info">
                        <div class="schedule-time">
                            ${formatDateTime(startTime)} - ${formatTime(endTime)}
                        </div>
                        <div class="schedule-duration">
                            Duration: ${durationMinutes}  minutes
                        </div>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        // éªŒè¯æ—¶é—´æ ¼å¼
        function validateDateTime(datetimeString) {
            if (!datetimeString) return false;
            
            const date = new Date(datetimeString);
            const now = new Date();
            
            if (date <= now) {
                showScheduleMessage('Start time must be later than current time', 'error');
                return false;
            }
            // æ˜¾ç¤ºç¡®è®¤ä¿¡æ¯
            const timeStr = date.toLocaleString('zh-CN', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit', 
                minute: '2-digit'
            });
            console.log(`è®¡åˆ’æ—¶é—´: ${timeStr}`);
            return true;
        }

        // æ·»åŠ å½•éŸ³è®¡åˆ’
        async function addSchedule() {
            const deviceId = document.getElementById('deviceSelect').value;
            const startDateTime = document.getElementById('scheduleStartDateTime').value;
            const duration = parseInt(document.getElementById('scheduleDuration').value);
            
            if (!deviceId || !startDateTime || !duration) {
                showScheduleMessage('Please fill in complete schedule information', 'error');
                return;
            }
            
            // éªŒè¯æ—¶é—´æ ¼å¼
            if (!validateDateTime(startDateTime)) {
                return;
            }
            
            const startTimestamp = Math.floor(new Date(startDateTime).getTime() / 1000);
            const durationSeconds = duration * 60;
            
            try {
                const response = await fetch(`/schedules/${deviceId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        start_at: startTimestamp,
                        duration: durationSeconds
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showScheduleMessage('schedule added successfully', 'success');
                    setDefaultDateTime(); // é‡æ–°è®¾ç½®é»˜è®¤æ—¶é—´
                    document.getElementById('scheduleDuration').value = '60';
                    await loadSchedules();
                } else {
                    showScheduleMessage('Add failed: ' + data.message, 'error');
                }
                
            } catch (error) {
                showScheduleMessage('Add failed: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºè®¡åˆ’æ¶ˆæ¯
        function showScheduleMessage(text, type) {
            const messageDiv = document.getElementById('scheduleMessage');
            const className = type === 'success' ? 'success' : 'error';
            messageDiv.innerHTML = `<div class="${className}" style="margin: 10px 0; padding: 10px 15px; border-radius: 6px; background-color: ${type === 'success' ? '#c6f6d5' : '#fed7d7'}; color: ${type === 'success' ? '#22543d' : '#c53030'};">${text}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 3000);
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ï¼ˆç”¨äºè®¡åˆ’æ˜¾ç¤ºï¼‰
        function formatDateTime(date) {
            return date.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆç”¨äºè®¡åˆ’æ˜¾ç¤ºï¼‰
        function formatTime(date) {
            return date.toLocaleString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const transcriptModal = document.getElementById('transcriptModal');
            const scheduleModal = document.getElementById('scheduleModal');
            if (event.target === transcriptModal) {
                transcriptModal.style.display = 'none';
            }
            if (event.target === scheduleModal) {
                scheduleModal.style.display = 'none';
            }
        }

        // è®¾ç½®é»˜è®¤æ—¶é—´ä¸ºå½“å‰æ—¶é—´+1 minutes
        function setDefaultDateTime() {
            const now = new Date();
            // è®¾ç½®ä¸ºå½“å‰æ—¶é—´+1 minutes
            now.setMinutes(now.getMinutes() + 1);
            now.setSeconds(0);
            now.setMilliseconds(0);
            
            // æ ¼å¼åŒ–ä¸º datetime-local æ ¼å¼
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            const datetimeString = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            const dateTimeInput = document.getElementById('scheduleStartDateTime');
            if (dateTimeInput) {
                dateTimeInput.value = datetimeString;
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            loadDevices();
            setDefaultDateTime(); // è®¾ç½®é»˜è®¤æ—¶é—´
            
            // ä¸ºæ—¥æœŸæ—¶é—´è¾“å…¥æ¡†æ·»åŠ ç‚¹å‡»äº‹ä»¶
            const dateTimeInput = document.getElementById('scheduleStartDateTime');
            if (dateTimeInput) {
                // å½“è¾“å…¥æ¡†ä¸ºç©ºä¸”è·å¾—ç„¦ç‚¹æ—¶ï¼Œè‡ªåŠ¨è®¾ç½®å½“å‰æ—¶é—´
                dateTimeInput.addEventListener('focus', function() {
                    if (!this.value) {
                        setDefaultDateTime();
                    }
                });
                
                // å½“è¾“å…¥æ¡†è¢«ç‚¹å‡»æ—¶ï¼Œå¦‚æœå€¼ä¸ºç©ºæˆ–æ— æ•ˆï¼Œé‡æ–°è®¾ç½®æ—¶é—´
                dateTimeInput.addEventListener('click', function() {
                    if (!this.value || new Date(this.value) < new Date()) {
                        setDefaultDateTime();
                    }
                });
            }
        };
    </script>
</body>
</html>